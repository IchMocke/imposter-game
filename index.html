<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Wortspiel</title>
    <!-- Firebase SDK einfügen -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        
    /* NEUE CSS-VARIABLEN FÜR DARK MODE */
    :root {
        --bg-color: #f0f2f5;
        --container-bg: white;
        --text-color: #333;
        --card-bg: #eee;
        --inactive-tab: #e9ecef;
        --button-color: #5865F2;
        --button-text: white;
        --info-block: #e9ecef;
        --border-color: #ddd;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --normal-player-bg: #43B581;
        --imposter-bg: #F04747;
        --voting-option: #e9ecef;
        --voting-hover: #d0d7de;
        --vote-count-bg: #e9ecef;
    }

    /* NEUE DARK MODE KLASSE */
    .dark-mode {
        --bg-color: #121212;
        --container-bg: #1e1e1e;
        --text-color: #e0e0e0;
        --card-bg: #2d2d2d;
        --inactive-tab: #2d2d2d;
        --button-color: #5865F2;
        --button-text: white;
        --info-block: #2d2d2d;
        --border-color: #444;
        --shadow-color: rgba(0, 0, 0, 0.3);
        --normal-player-bg: #43B581;
        --imposter-bg: #F04747;
        --voting-option: #2d2d2d;
        --voting-hover: #3d3d3d;
        --vote-count-bg: #2d2d2d;
    }

    /* GEÄNDERTE STYLES - JETZT MIT VARIABLEN */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    .container {
        background-color: var(--container-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px var(--shadow-color);
        transition: background-color 0.3s, box-shadow 0.3s;
    }
    h1 {
        color: var(--text-color);
        transition: color 0.3s;
        text-align: center;   
    }
    h2, h3 {
        color: var(--text-color);
        transition: color 0.3s;      
    }
    input, button, select {
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        width: 100%;
        box-sizing: border-box;
        background-color: var(--container-bg);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    button {
        background-color: var(--button-color);
        color: var(--button-text);
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    button:hover {
        background-color: #4752C4;
    }
    .hidden {
        display: none;
    }
    .role-display {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        font-size: 18px;
    }
    .normal-player {
        background-color: var(--normal-player-bg);
        color: white;
    }
    .imposter {
        background-color: var(--imposter-bg);
        color: white;
    }
    .word-display {
        font-weight: bold;
        font-size: 24px;
        margin: 10px 0;
    }
    .player-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
    }
    .player-card {
        background: var(--card-bg);
        padding: 8px 12px;
        border-radius: 20px;
        display: inline-block;
        transition: background-color 0.3s;
    }
    .game-code {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin: 15px 0;
        padding: 10px;
        background: var(--info-block);
        border-radius: 4px;
        transition: background-color 0.3s;
    }
    .tabs {
        display: flex;
        margin-bottom: 20px;
    }
    .tab {
        padding: 10px 20px;
        cursor: pointer;
        background: var(--inactive-tab);
        border-radius: 4px 4px 0 0;
        margin-right: 5px;
        transition: background-color 0.3s, color 0.3s;
    }
    .tab.active {
        background: var(--button-color);
        color: white;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .small-text {
        font-size: 12px;
        color: #666;
    }
    .info-block {
        background: var(--info-block);
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
        transition: background-color 0.3s;
    }
    .category-select {
        margin-bottom: 15px;
    }
    .category-option {
        display: inline-block;
        margin: 5px;
        padding: 10px 15px;
        background: var(--info-block);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .category-option:hover {
        background: var(--voting-hover);
    }
    .category-option.selected {
        background: var(--button-color);
        color: white;
    }
    .word-selection {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
    }
    .or-divider {
        text-align: center;
        margin: 15px 0;
        position: relative;
    }
    .or-divider:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--border-color);
    }
    .or-divider span {
        background: var(--container-bg);
        padding: 0 10px;
        position: relative;
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }

    .player-order-section {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--info-block);
        border-radius: 6px;
        transition: background-color 0.3s;
    }
    .player-order-list {
        padding-left: 25px;
    }
    .player-order-list li {
        margin: 8px 0;
        padding: 8px 12px;
        background-color: var(--card-bg);
        border-radius: 4px;
        transition: background-color 0.3s;
    }
    .current-player {
        background-color: var(--button-color) !important;
        color: white;
        font-weight: bold;
    }

    .player-voting-option {
        padding: 10px;
        margin: 5px 0;
        background-color: var(--voting-option);
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .player-voting-option:hover {
        background-color: var(--voting-hover);
    }
    
    .player-voting-option.selected {
        background-color: var(--button-color);
        color: white;
    }
    
    #resultSection {
        margin-top: 20px;
        padding: 15px;
        background-color: var(--info-block);
        border-radius: 6px;
        transition: background-color 0.3s;
    }
    
    .imposter-reveal {
        color: var(--imposter-bg);
        font-weight: bold;
    }
    
    .word-reveal {
        color: var(--normal-player-bg);
        font-weight: bold;
    }
    
    .vote-count {
        background: var(--vote-count-bg);
        border-radius: 50%;
        display: inline-block;
        width: 24px;
        height: 24px;
        text-align: center;
        line-height: 24px;
        margin-left: 10px;
        transition: background-color 0.3s;
    }

    /* NEUER STYLE FÜR DEN THEME TOGGLE BUTTON */
    .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: var(--button-color);
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 100;
        transition: transform 0.3s;
    }

    .theme-toggle:hover {
        transform: scale(1.1);
    }

    #startNewRoundBtn {
        margin-top: 20px;
        background-color: var(--normal-player-bg);
    }
    
    #startNewRoundBtn:hover {
        background-color: #36A46E;
    }

        

    @media (max-width: 600px) {
        .theme-toggle {
            top: 10px;
            right: 10px;
            width: 35px;
            height: 35px;
        }
    }        
    </style>
   
</head>

    
<body>

    <button class="theme-toggle" id="themeToggle">🌙</button>
    
    <div class="container">
        <h1>Imposter Wortspiel</h1>
        
        <div class="tabs">
            <div class="tab active" id="hostTab">Spiel erstellen</div>
            <div class="tab" id="joinTab">Spiel beitreten</div>
        </div>
        
        <!-- Host Game Section -->
        <div class="section" id="hostSection">
            <h2>Neues Spiel erstellen</h2>
            
            <div class="form-group">
                <label for="hostName">Dein Name:</label>
                <input type="text" id="hostName" placeholder="Dein Name">
            </div>
            
            <div class="form-group">
                <label for="playerCount">Anzahl der Spieler:</label>
                <input type="number" id="playerCount" min="3" value="4">
            </div>
            
            <div class="form-group">
                <label>Wähle eine Kategorie:</label>
                <div class="category-select" id="categorySelect">
                    <div class="category-option" data-category="tiere">Tiere</div>
                    <div class="category-option" data-category="berufe">Berufe</div>
                    <div class="category-option" data-category="gegenstaende">Gegenstände</div>
                    <div class="category-option" data-category="orte">Orte</div>
                    <div class="category-option" data-category="essen">Essen & Trinken</div>
                </div>
            </div>
            
            <div class="or-divider">
                <span>ODER</span>
            </div>
            
            <div class="form-group">
                <label for="wordInput">Eigenes Wort eingeben:</label>
                <input type="text" id="wordInput" placeholder="z.B. Sonne">
            </div>
            
            <button id="createGameBtn">Spiel erstellen</button>
            
            <div class="info-block hidden" id="gameCodeSection">
                <p>Teile diesen Code mit deinen Mitspielern:</p>
                <div class="game-code" id="gameCodeDisplay"></div>
                <p class="small-text">Die Spieler können mit diesem Code dem Spiel beitreten.</p>
                
                <h3>Spielerliste:</h3>
                <div class="player-list" id="hostPlayerList">
                    <!-- Player list will be generated here -->
                </div>
                
                <button id="startGameBtn" class="hidden">Spiel starten</button>
            </div>
        </div>
        
        <!-- Join Game Section (Initially Hidden) -->
        <div class="section hidden" id="joinSection">
            <h2>Einem Spiel beitreten</h2>
            
            <div class="form-group">
                <label for="playerName">Dein Name:</label>
                <input type="text" id="playerName" placeholder="Dein Name">
            </div>
            
            <div class="form-group">
                <label for="gameCodeInput">Spiel-Code:</label>
                <input type="text" id="gameCodeInput" placeholder="z.B. ABC123">
            </div>
            
            <button id="joinGameBtn">Spiel beitreten</button>
            
            <div class="info-block hidden" id="waitingRoomSection">
                <h3>Warte auf Spielstart...</h3>
                <p>Der Spielleiter wird das Spiel bald starten.</p>
                
                <h3>Spielerliste:</h3>
                <div class="player-list" id="joinPlayerList">
                    <!-- Player list will be generated here -->
                </div>
            </div>
        </div>
        
        <!-- Game View Section (Initially Hidden) -->
        <div class="section hidden" id="gameSection">
            <h2>Spiel läuft</h2>
            
            <div class="role-display" id="playerRoleDisplay">
                <!-- Role will be displayed here -->
            </div>
            
            <h3>Spielerliste:</h3>
            <div class="player-list" id="gamePlayerList">
                <!-- Player list will be generated here -->
            </div>

            <div class="player-order-section">
            <h3>Spielerreihenfolge:</h3>
            <ol id="playerOrderList" class="player-order-list">
            <!-- Spielerreihenfolge wird hier angezeigt -->
            </ol>
            </div>

            <div class="section" id="votingSection" style="display:none;">
            <h2>Abstimmungsphase</h2>




                
            <!-- Für normale Spieler: Abstimmung -->
            <div id="normalPlayerVoting" style="display:none;">
                <p>Wer ist deiner Meinung nach der Imposter?</p>
                <div id="votingPlayerList" class="player-voting-list">
                    <!-- Wird dynamisch gefüllt -->
                </div>
                <p id="voteConfirmation" class="hidden" style="color: green; font-weight: bold;">Deine Stimme wurde gezählt!</p>
            </div>
            
            <!-- Für den Imposter: Wort erraten -->
            <div id="imposterGuessing" style="display:none;">
                <p>Errate das geheime Wort:</p>
                <input type="text" id="wordGuessInput" placeholder="Deine Vermutung...">
                <button id="submitGuessBtn">Wort einreichen</button>
                <p id="guessConfirmation" class="hidden" style="color: green; font-weight: bold;">Deine Vermutung wurde gesendet!</p>
            </div>
        </div>
        
        <div class="section" id="resultSection" style="display:none;">
            <h2>Spielergebnis</h2>
            <div id="resultContent">
                <!-- Wird dynamisch gefüllt -->
            </div>
            <button id="startNewRoundBtn" class="hidden">Neue Runde starten</button>
            
        </div>
        
        <button id="endDiscussionBtn" style="display:none;">Diskussion beenden & Abstimmung starten</button>




            
            
            <button id="newGameBtn">Neues Spiel</button>
        </div>
    </div>

    <script>
        

    // Firebase-Konfiguration 
    const firebaseConfig = {
        apiKey: "AIzaSyCdEAZokf96Rmb4UfqR6MdCYDmlWlszxTA",
        authDomain: "imposter-wortspiel.firebaseapp.com",
        databaseURL: "https://imposter-wortspiel-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "imposter-wortspiel",
        storageBucket: "imposter-wortspiel.firebasestorage.app",
        messagingSenderId: "661252503301",
        appId: "1:661252503301:web:57766f2c4faa0b3f08296c"
    };
    
    // Firebase im Kompatibilitätsmodus initialisieren
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();



        
        // Word categories
        const wordCategories = {
            tiere: [
                "Elefant", "Pinguin", "Giraffe", "Löwe", "Tiger", "Zebra", "Känguru", "Nashorn", 
                "Koala", "Panda", "Delfin", "Wal", "Hai", "Frosch", "Schildkröte", "Adler", 
                "Papagei", "Flamingo", "Krokodil", "Gorilla", "Eisbär", "Wolf", "Fuchs", 
                "Igel", "Eichhörnchen", "Biber", "Otter", "Fledermaus"
            ],
            berufe: [
                "Arzt", "Lehrer", "Koch", "Feuerwehrmann", "Polizist", "Pilot", "Architekt", 
                "Designer", "Programmierer", "Schauspieler", "Musiker", "Künstler", "Anwalt", 
                "Richter", "Journalist", "Fotograf", "Bäcker", "Gärtner", "Tischler", "Elektriker", 
                "Friseur", "Mechaniker", "Schneider", "Zahnarzt", "Tierarzt", "Krankenpfleger"
            ],
            gegenstaende: [
                "Stuhl", "Tisch", "Lampe", "Uhr", "Buch", "Stift", "Handy", "Computer", "Fernseher", 
                "Kamera", "Brille", "Schlüssel", "Tasche", "Schirm", "Geldbörse", "Schere", "Tasse", 
                "Flasche", "Messer", "Gabel", "Löffel", "Teller", "Vase", "Kissen", "Decke", "Spiegel", 
                "Kerze", "Bild", "Ring", "Kette", "Mütze", "Schal"
            ],
            orte: [
                "Strand", "Berg", "Wald", "Wüste", "Insel", "Stadt", "Dorf", "Park", "Zoo", "Museum", 
                "Kino", "Theater", "Restaurant", "Café", "Bahnhof", "Flughafen", "Hafen", "Schule", 
                "Universität", "Krankenhaus", "Hotel", "Supermarkt", "Bibliothek", "Schwimmbad", 
                "Fitnessstudio", "Büro", "Fabrik", "Bauernhof", "Schloss", "Kirche"
            ],
            essen: [
                "Pizza", "Burger", "Pasta", "Sushi", "Schokolade", "Eis", "Kuchen", "Brot", "Käse", 
                "Suppe", "Salat", "Steak", "Fisch", "Hühnchen", "Reis", "Kartoffel", "Apfel", "Banane", 
                "Orange", "Erdbeere", "Tomate", "Gurke", "Karotte", "Kaffee", "Tee", "Saft", "Wasser", 
                "Bier", "Wein", "Milch"
            ]
        };
        
        // Spielzustand
        const gameState = {
            gameCode: '',
            word: '',
            category: '',
            players: [],
            imposterIndex: -1,
            started: false,
            currentPlayerName: '',
            votes: {},
            wordGuess: '',
            votingComplete: false,
            playersVoted: [],
            isHost: false
        };
        
        // DOM Elements
        const hostTab = document.getElementById('hostTab');
        const joinTab = document.getElementById('joinTab');
        const hostSection = document.getElementById('hostSection');
        const joinSection = document.getElementById('joinSection');
        const gameSection = document.getElementById('gameSection');
        
        const hostName = document.getElementById('hostName');
        const playerCount = document.getElementById('playerCount');
        const categorySelect = document.getElementById('categorySelect');
        const wordInput = document.getElementById('wordInput');
        const createGameBtn = document.getElementById('createGameBtn');
        
        const gameCodeSection = document.getElementById('gameCodeSection');
        const gameCodeDisplay = document.getElementById('gameCodeDisplay');
        const hostPlayerList = document.getElementById('hostPlayerList');
        const startGameBtn = document.getElementById('startGameBtn');
        
        const playerName = document.getElementById('playerName');
        const gameCodeInput = document.getElementById('gameCodeInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        
        const waitingRoomSection = document.getElementById('waitingRoomSection');
        const joinPlayerList = document.getElementById('joinPlayerList');
        
        const playerRoleDisplay = document.getElementById('playerRoleDisplay');
        const gamePlayerList = document.getElementById('gamePlayerList');
        const newGameBtn = document.getElementById('newGameBtn');
        
        // Tab navigation
        hostTab.addEventListener('click', () => {
            hostTab.classList.add('active');
            joinTab.classList.remove('active');
            hostSection.classList.remove('hidden');
            joinSection.classList.add('hidden');
        });
        
        joinTab.addEventListener('click', () => {
            joinTab.classList.add('active');
            hostTab.classList.remove('active');
            joinSection.classList.remove('hidden');
            hostSection.classList.add('hidden');
        });

        // Kategorie-Auswahl
        const categoryOptions = categorySelect.querySelectorAll('.category-option');
        categoryOptions.forEach(option => {
            option.addEventListener('click', () => {
                categoryOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                gameState.category = option.dataset.category;
            });
        });
        
        // Spielcode generieren
        function generateGameCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }

        
        
        // Spiel erstellen (Host)
        createGameBtn.addEventListener('click', () => {
            const name = hostName.value.trim();
            const count = parseInt(playerCount.value);
            const customWord = wordInput.value.trim();
            
            if (name === '') {
                alert('Bitte gib deinen Namen ein.');
                return;
            }
            
            if (count < 3) {
                alert('Es müssen mindestens 3 Spieler sein.');
                return;
            }
            
            if (!gameState.category && customWord === '') {
                alert('Bitte wähle eine Kategorie oder gib ein eigenes Wort ein.');
                return;
            }





            
            
            // Spielcode generieren
            const gameCode = generateGameCode();
            gameState.gameCode = gameCode;
            gameState.currentPlayerName = name;
            gameState.isHost = true;
            
            // Wort festlegen
            if (customWord !== '') {
                gameState.word = customWord;
            } else {
                const categoryWords = wordCategories[gameState.category];
                gameState.word = categoryWords[Math.floor(Math.random() * categoryWords.length)];
            }
            
            // Spieler hinzufügen
            gameState.players = [name];
            
            // Spiel in Firebase erstellen
            database.ref('games/' + gameCode).set({
                code: gameCode,
                word: gameState.word,
                category: gameState.category || 'custom',
                players: gameState.players,
                started: false,
                hostName: name,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                votes: {},          
                playersVoted: [],   
                votingPhase: false  
            });
            
            // Host dieser Spielsitzung zuordnen
            database.ref('games/' + gameCode + '/players').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.players = snapshot.val();
                    updateHostPlayerList();
                    
                    if (gameState.players.length >= 3) {
                        startGameBtn.classList.remove('hidden');
                    }
                }
            });

            database.ref('games/' + gameCode + '/playerOrder').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.playerOrder = snapshot.val();
                    if (gameState.started) {
                        updatePlayerOrderList();
                    }
                }
            });
            
            // Spielstatus überwachen
            database.ref('games/' + gameCode + '/started').on('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    gameState.started = true;
                    
                    // Imposter-Index abrufen
                    database.ref('games/' + gameCode + '/imposterIndex').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            gameState.imposterIndex = snapshot.val();
                            showGameView();
                        }
                    });
                }
            });
            
            // Spielcode anzeigen
            gameCodeDisplay.textContent = gameCode;
            gameCodeSection.classList.remove('hidden');
        });
        





        
// Spiel beitreten (Spieler)
joinGameBtn.addEventListener('click', () => {
    const name = playerName.value.trim();
    const code = gameCodeInput.value.trim().toUpperCase();
    
    if (name === '') {
        alert('Bitte gib deinen Namen ein.');
        return;
    }
    
    if (code === '') {
        alert('Bitte gib den Spiel-Code ein.');
        return;
    }


    database.ref('games/' + code + '/playerOrder').on('value', (snapshot) => {
        if (snapshot.exists()) {
            gameState.playerOrder = snapshot.val();
            if (gameState.started) {
                updatePlayerOrderList();
            }
        }
    });
    
    // Prüfen, ob Spiel existiert
    database.ref('games/' + code).once('value', (snapshot) => {
        if (snapshot.exists()) {
            const game = snapshot.val();
            
            // Prüfen, ob Name bereits verwendet wird
            if (game.players && game.players.includes(name)) {
                alert('Dieser Name wird bereits verwendet. Bitte wähle einen anderen Namen.');
                return;
            }
            
            // Prüfen, ob Spiel bereits gestartet ist
            if (game.started) {
                alert('Das Spiel hat bereits begonnen. Bitte trete einem anderen Spiel bei.');
                return;
            }
            
            // Spieler zum Spiel hinzufügen
            gameState.gameCode = code;
            gameState.currentPlayerName = name;
            
            // Spielerliste für Spieler initialisieren
            gameState.players = game.players || [];
            if (!gameState.players.includes(name)) {
                gameState.players.push(name);
            }
            
            // Spieler zur Spielerliste in Firebase hinzufügen
            database.ref('games/' + code + '/players').set(gameState.players);
            
            // Spielzustand überwachen
            database.ref('games/' + code + '/players').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.players = snapshot.val();
                    gameState.playerOrder = [];
                    updateJoinPlayerList();
                }
            });
            
            // Spielstatus überwachen
            database.ref('games/' + code + '/started').on('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    gameState.started = true;
                    
                    // Spielwort und Imposter-Index abrufen
                    database.ref('games/' + code).once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const gameData = snapshot.val();
                            gameState.word = gameData.word;
                            gameState.imposterIndex = gameData.imposterIndex;
                            showGameView();
                        }
                    });
                }
            });
            
            // Warteraum anzeigen
            waitingRoomSection.classList.remove('hidden');
        } else {
            alert('Ungültiger Spiel-Code. Bitte überprüfe den Code und versuche es erneut.');
        }
    });
});





        
        startGameBtn.addEventListener('click', () => {
            if (!gameState.isHost) return;
            
            if (gameState.players.length < 3) {
                alert('Es müssen mindestens 3 Spieler sein, um das Spiel zu starten.');
                return;
            }
            
            // Imposter zufällig auswählen
            const imposterIndex = Math.floor(Math.random() * gameState.players.length);
            
            // Zufällige Spielerreihenfolge erstellen
            const playerOrder = createRandomPlayerOrder(gameState.players);
            
            // Spiel starten und Imposter sowie Spielerreihenfolge setzen
            database.ref('games/' + gameState.gameCode).update({
                started: true,
                imposterIndex: imposterIndex,
                playerOrder: playerOrder
            });
            
            gameState.imposterIndex = imposterIndex;
            gameState.playerOrder = playerOrder;
        });
        
        
        // Neues Spiel starten
        newGameBtn.addEventListener('click', () => {
            // Spiel verlassen und zurücksetzen
            if (gameState.gameCode) {
                // Vom Firebase-Listener abmelden
                database.ref('games/' + gameState.gameCode).off();
                
                // Wenn Host und keine Spieler mehr da sind, Spiel löschen
                if (gameState.isHost) {
                    database.ref('games/' + gameState.gameCode).remove();
                } else {
                    // Spieler aus Liste entfernen
                    database.ref('games/' + gameState.gameCode + '/players').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const players = snapshot.val();
                            const index = players.indexOf(gameState.currentPlayerName);
                            if (index !== -1) {
                                players.splice(index, 1);
                                database.ref('games/' + gameState.gameCode + '/players').set(players);
                            }
                        }
                    });
                }
            }

            
// Gamestate zurücksetzen
            gameState.gameCode = '';
            gameState.word = '';
            gameState.category = '';
            gameState.players = [];
            gameState.imposterIndex = -1;
            gameState.started = false;
            gameState.isHost = false;
            gameState.votes = {};
            gameState.wordGuess = '';
            gameState.votingComplete = false;
            gameState.playersVoted = [];
            
            // UI zurücksetzen
            hostSection.classList.remove('hidden');
            joinSection.classList.add('hidden');
            gameSection.classList.add('hidden');
            gameCodeSection.classList.add('hidden');
            waitingRoomSection.classList.add('hidden');
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('endDiscussionBtn').style.display = 'none';
            document.getElementById('normalPlayerVoting').style.display = 'none';
            document.getElementById('imposterGuessing').style.display = 'none';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            
            // Eingaben und Auswahlen zurücksetzen
            wordInput.value = '';
            gameCodeInput.value = '';
            categoryOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Tabs zurücksetzen
            hostTab.classList.add('active');
            joinTab.classList.remove('active');
        });



        //Neuer Event Listener
        document.getElementById('startNewRoundBtn').addEventListener('click', () => {
            if (!gameState.isHost) return;
            
            // Neues Wort auswählen, falls eine Kategorie ausgewählt ist
            let newWord = '';
            if (gameState.category && gameState.category !== 'custom') {
                const categoryWords = wordCategories[gameState.category];
                newWord = categoryWords[Math.floor(Math.random() * categoryWords.length)];
            } else if (wordInput.value.trim() !== '') {
                // Benutzerdefiniertes Wort verwenden, wenn verfügbar
                newWord = wordInput.value.trim();
            } else {
                // Behalte das aktuelle Wort bei, wenn keine neue Quelle verfügbar ist
                newWord = gameState.word;
            }
            
            // Spielzustand vollständig zurücksetzen
            gameState.started = false;
            gameState.votes = {};
            gameState.wordGuess = '';
            gameState.votingComplete = false;
            gameState.playersVoted = [];
            gameState.word = newWord; // Wichtig: Neues Wort im lokalen Status speichern
            gameState.imposterIndex = -1; // Zurücksetzen des Imposter-Index
            
            // UI für Host zurücksetzen
            gameSection.classList.add('hidden');
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('normalPlayerVoting').style.display = 'none';
            document.getElementById('imposterGuessing').style.display = 'none';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            
            // Host-Interface mit Spielern anzeigen
            hostSection.classList.remove('hidden');
            gameCodeSection.classList.remove('hidden');
            startGameBtn.classList.remove('hidden');
            
            // Firebase vollständig zurücksetzen
            database.ref('games/' + gameState.gameCode).update({
                started: false,
                votes: {},
                playersVoted: [],
                votingPhase: false,
                wordGuess: null,
                word: newWord, // Wichtig: Neues Wort in Firebase aktualisieren
                imposterIndex: null // Imposter-Index zurücksetzen
            });
        });
        




        
        
        // Spielerlisten aktualisieren (wie in deinem Original-Code)
        function updateHostPlayerList() {
            hostPlayerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.textContent = player;
                hostPlayerList.appendChild(playerCard);
            });
        }
        
        function updateJoinPlayerList() {
            joinPlayerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.textContent = player;
                joinPlayerList.appendChild(playerCard);
            });
        }
        
        function updateGamePlayerList() {
            gamePlayerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.textContent = player;
                gamePlayerList.appendChild(playerCard);
            });
        }

        function updatePlayerOrderList() {
            const playerOrderList = document.getElementById('playerOrderList');
            playerOrderList.innerHTML = '';
            
            gameState.playerOrder.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player; // Nur den Spielernamen ohne Nummerierung
                playerOrderList.appendChild(li);
            });
        }

        function createRandomPlayerOrder(players) {
            // Kopie der Spielerliste erstellen
            const shuffledPlayers = [...players];
            
            // Fisher-Yates Shuffle Algorithmus
            for (let i = shuffledPlayers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledPlayers[i], shuffledPlayers[j]] = [shuffledPlayers[j], shuffledPlayers[i]];
            }
            
            return shuffledPlayers;
        }




        
        // Spielansicht anzeigen
        function showGameView() {
            hostSection.classList.add('hidden');
            joinSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
            
            // Spielerrolle anzeigen
            const playerIndex = gameState.players.indexOf(gameState.currentPlayerName);
            
            playerRoleDisplay.classList.remove('normal-player', 'imposter');
            
            if (playerIndex === gameState.imposterIndex) {
                playerRoleDisplay.classList.add('imposter');
                playerRoleDisplay.innerHTML = `
                    <p>Du bist der <strong>IMPOSTER</strong>!</p>
                    <p>Alle anderen Spieler kennen ein geheimes Wort, das du erraten musst.</p>
                    <p>Höre gut zu und versuche nicht aufzufallen!</p>
                `;
            } else {
                playerRoleDisplay.classList.add('normal-player');
                playerRoleDisplay.innerHTML = `
                    <p>Du bist ein <strong>normaler Spieler</strong>!</p>
                    <p>Das geheime Wort ist: <span class="word-display">${gameState.word}</span></p>
                    <p>Beschreibe das Wort, ohne es direkt zu nennen. Versuche den Imposter zu erkennen!</p>
                `;
            }
        
            updateGamePlayerList();
            
            // Spielerreihenfolge anzeigen, wenn vorhanden
            if (gameState.playerOrder && gameState.playerOrder.length > 0) {
                updatePlayerOrderList();
            }
            
            // "Diskussion beenden"-Button nur für Host anzeigen
            if (gameState.isHost) {
                document.getElementById('endDiscussionBtn').style.display = 'block';
            }
            
            // Abstimmungs- und Ergebnislistener einrichten
            setupVotingPhaseListener();
            setupVotingResultsListener();
        }







        
        
        // Auto-Cleanup für inaktive Spiele (optional)
        window.addEventListener('beforeunload', () => {
            if (gameState.gameCode) {
                // Vom Firebase-Listener abmelden
                database.ref('games/' + gameState.gameCode).off();
                
                if (gameState.isHost) {
                    // Als Host: Spiel löschen
                    database.ref('games/' + gameState.gameCode).remove();
                } else {
                    // Als Spieler: Aus Spielerliste entfernen
                    database.ref('games/' + gameState.gameCode + '/players').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const players = snapshot.val();
                            const index = players.indexOf(gameState.currentPlayerName);
                            if (index !== -1) {
                                players.splice(index, 1);
                                database.ref('games/' + gameState.gameCode + '/players').set(players);
                            }
                        }
                    });
                }
            }
        });








        // Diskussion beenden und Abstimmung starten
document.getElementById('endDiscussionBtn').addEventListener('click', () => {
    if (!gameState.isHost) return;
    
    database.ref('games/' + gameState.gameCode).update({
        votingPhase: true
    });
});

// Überwachung der Abstimmungsphase
function setupVotingPhaseListener() {
    database.ref('games/' + gameState.gameCode + '/votingPhase').on('value', (snapshot) => {
        if (snapshot.exists() && snapshot.val() === true) {
            showVotingSection();
        }
    });
}

// Zeige Abstimmungssektion
function showVotingSection() {
    document.getElementById('endDiscussionBtn').style.display = 'none';
    document.getElementById('votingSection').style.display = 'block';
    
    const playerIndex = gameState.players.indexOf(gameState.currentPlayerName);
    
    if (playerIndex === gameState.imposterIndex) {
        // Imposter sieht Ratefeld
        document.getElementById('imposterGuessing').style.display = 'block';
    } else {
        // Normale Spieler sehen Abstimmungsoptionen
        document.getElementById('normalPlayerVoting').style.display = 'block';
        populateVotingOptions();
    }
}

// Abstimmungsoptionen anzeigen
function populateVotingOptions() {
    const votingList = document.getElementById('votingPlayerList');
    votingList.innerHTML = '';
    
    gameState.players.forEach(player => {
        if (player !== gameState.currentPlayerName) { // Nicht für sich selbst stimmen
            const option = document.createElement('div');
            option.classList.add('player-voting-option');
            option.textContent = player;
            option.dataset.player = player;
            
            option.addEventListener('click', () => {
                // Vorherige Auswahl entfernen
                document.querySelectorAll('.player-voting-option.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Neue Auswahl markieren
                option.classList.add('selected');
                
                // Stimme in Firebase speichern
                const voteRef = database.ref('games/' + gameState.gameCode + '/votes/' + gameState.currentPlayerName);
                voteRef.set(player);
                
                // Abstimmungsbestätigung anzeigen
                document.getElementById('voteConfirmation').classList.remove('hidden');
                
                // Spieler zur Liste der abgestimmten Spieler hinzufügen
                database.ref('games/' + gameState.gameCode + '/playersVoted').once('value', (snapshot) => {
                    let playersVoted = [];
                    if (snapshot.exists()) {
                        playersVoted = snapshot.val();
                    }
                    
                    if (!playersVoted.includes(gameState.currentPlayerName)) {
                        playersVoted.push(gameState.currentPlayerName);
                        database.ref('games/' + gameState.gameCode + '/playersVoted').set(playersVoted);
                    }
                });
            });
            
            votingList.appendChild(option);
        }
    });
}

// Imposter-Rateversuch
document.getElementById('submitGuessBtn').addEventListener('click', () => {
    const wordGuess = document.getElementById('wordGuessInput').value.trim();
    
    if (wordGuess === '') {
        alert('Bitte gib eine Vermutung ein!');
        return;
    }
    
    // Vermutung in Firebase speichern
    database.ref('games/' + gameState.gameCode + '/wordGuess').set(wordGuess);
    
    // Bestätigung anzeigen
    document.getElementById('guessConfirmation').classList.remove('hidden');
    document.getElementById('submitGuessBtn').disabled = true;
    
    // Imposter zur Liste der abgestimmten Spieler hinzufügen
    database.ref('games/' + gameState.gameCode + '/playersVoted').once('value', (snapshot) => {
        let playersVoted = [];
        if (snapshot.exists()) {
            playersVoted = snapshot.val();
        }
        
        if (!playersVoted.includes(gameState.currentPlayerName)) {
            playersVoted.push(gameState.currentPlayerName);
            database.ref('games/' + gameState.gameCode + '/playersVoted').set(playersVoted);
        }
    });
});

// Überwachung der Abstimmungsergebnisse
function setupVotingResultsListener() {
    database.ref('games/' + gameState.gameCode + '/playersVoted').on('value', (snapshot) => {
        if (snapshot.exists()) {
            const playersVoted = snapshot.val();
            
            // Wenn alle Spieler abgestimmt haben
            if (playersVoted.length === gameState.players.length) {
                showResults();
            }
        }
    });

    database.ref('games/' + gameState.gameCode + '/started').on('value', (snapshot) => {
        if (snapshot.exists() && snapshot.val() === false && gameState.started === true) {
            // Zurück in den Warteraum, wenn der Host eine neue Runde startet
            if (!gameState.isHost) {
                gameSection.classList.add('hidden');
                document.getElementById('votingSection').style.display = 'none';
                document.getElementById('resultSection').style.display = 'none';
                joinSection.classList.remove('hidden');
                waitingRoomSection.classList.remove('hidden');
                
                // Zustand zurücksetzen
                gameState.started = false;
                gameState.votes = {};
                gameState.wordGuess = '';
                gameState.votingComplete = false;
                gameState.playersVoted = [];
            }
        }
    });
}

// Ergebnisse anzeigen
function showResults() {
    document.getElementById('votingSection').style.display = 'none';
    document.getElementById('resultSection').style.display = 'block';
    
    // Abstimmungsergebnisse und Imposter-Vermutung abrufen
    database.ref('games/' + gameState.gameCode).once('value', (snapshot) => {
        if (snapshot.exists()) {
            const gameData = snapshot.val();
            const votes = gameData.votes || {};
            const wordGuess = gameData.wordGuess || "nichts geraten";
            const imposter = gameState.players[gameState.imposterIndex];
            
            // Stimmen zählen
            const voteCounts = {};
            Object.values(votes).forEach(vote => {
                voteCounts[vote] = (voteCounts[vote] || 0) + 1;
            });
            
            // Ergebnisse anzeigen
            const resultContent = document.getElementById('resultContent');
            
            let resultHTML = `
                <p>Der <span class="imposter-reveal">Imposter</span> war: <strong>${imposter}</strong></p>
                <p>Das geheime Wort war: <span class="word-reveal">${gameState.word}</span></p>
                <p>Der Imposter hat geraten: <strong>${wordGuess}</strong></p>
                <h3>Abstimmungsergebnisse:</h3>
                <ul>
            `;
            
            // Spieler sortieren nach Stimmenzahl
            const sortedPlayers = Object.keys(voteCounts).sort((a, b) => voteCounts[b] - voteCounts[a]);
            
            sortedPlayers.forEach(player => {
                resultHTML += `<li>${player} <span class="vote-count">${voteCounts[player]}</span></li>`;
            });
            
            resultHTML += `</ul>`;
            resultContent.innerHTML = resultHTML;
        }
    });



    
        if (gameState.isHost) {
        document.getElementById('startNewRoundBtn').classList.remove('hidden');
    }


    
}


        


// Dark Mode Funktionalität
const themeToggle = document.getElementById('themeToggle');
let darkMode = localStorage.getItem('darkMode') === 'true';

// Beim Laden der Seite prüfen, ob Dark Mode aktiviert sein sollte
if (darkMode) {
    document.body.classList.add('dark-mode');
    themeToggle.textContent = '☀️';
}

// Toggle Dark Mode Funktion
themeToggle.addEventListener('click', () => {
    darkMode = !darkMode;
    localStorage.setItem('darkMode', darkMode);
    
    if (darkMode) {
        document.body.classList.add('dark-mode');
        themeToggle.textContent = '☀️';
    } else {
        document.body.classList.remove('dark-mode');
        themeToggle.textContent = '🌙';
    }
});

        
    </script>
</body>
</html>
