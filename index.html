<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imposter Wortspiel</title>
    <!-- Firebase SDK einf√ºgen -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- CSS einbinden -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <button class="theme-toggle" id="themeToggle">üåô</button>
    
    <div class="container">
        <h1>Imposter Wortspiel</h1>
        
        <div class="tabs">
            <div class="tab active" id="hostTab">Spiel erstellen</div>
            <div class="tab" id="joinTab">Spiel beitreten</div>
        </div>
        
        <!-- Host Game Section -->
        <div class="section" id="hostSection">
            <h2>Neues Spiel erstellen</h2>
            
            <div class="form-group">
                <label for="hostName">Dein Name:</label>
                <input type="text" id="hostName" placeholder="Dein Name">
            </div>
            
            <div class="form-group">
                <label for="playerCount">Anzahl der Spieler:</label>
                <input type="number" id="playerCount" min="3" value="4">
            </div>
            
            <div class="form-group">
                <label>W√§hle eine Kategorie:</label>
                <div class="category-select" id="categorySelect">
                    <div class="category-option" data-category="Tiere">Tiere</div>
                    <div class="category-option" data-category="Berufe">Berufe</div>
                    <div class="category-option" data-category="Gegenstaende">Gegenst√§nde</div>
                    <div class="category-option" data-category="Orte">Orte</div>
                    <div class="category-option" data-category="Essen">Essen & Trinken</div>
                </div>
            </div>
            
            <div class="or-divider">
                <span>ODER</span>
            </div>
            
            <div class="form-group">
                <label for="wordInput">Eigenes Wort eingeben:</label>
                <input type="text" id="wordInput" placeholder="z.B. Sonne">
            </div>
            
            <button id="createGameBtn">Spiel erstellen</button>
            
            <div class="info-block hidden" id="gameCodeSection">
                <p>Teile diesen Code mit deinen Mitspielern:</p>
                <div class="game-code" id="gameCodeDisplay"></div>
                <p class="small-text">Die Spieler k√∂nnen mit diesem Code dem Spiel beitreten.</p>
                
                <h3>Spielerliste:</h3>
                <div class="player-list" id="hostPlayerList">
                    <!-- Player list will be generated here -->
                </div>
                
                <button id="startGameBtn" class="hidden">Spiel starten</button>
            </div>
        </div>
        
        <!-- Join Game Section (Initially Hidden) -->
        <div class="section hidden" id="joinSection">
            <h2>Einem Spiel beitreten</h2>
            
            <div class="form-group">
                <label for="playerName">Dein Name:</label>
                <input type="text" id="playerName" placeholder="Dein Name">
            </div>
            
            <div class="form-group">
                <label for="gameCodeInput">Spiel-Code:</label>
                <input type="text" id="gameCodeInput" placeholder="z.B. ABC123">
            </div>
            
            <button id="joinGameBtn">Spiel beitreten</button>
            
            <div class="info-block hidden" id="waitingRoomSection">
                <h3>Warte auf Spielstart...</h3>
                <p>Der Spielleiter wird das Spiel bald starten.</p>
                
                <h3>Spielerliste:</h3>
                <div class="player-list" id="joinPlayerList">
                    <!-- Player list will be generated here -->
                </div>
            </div>
        </div>
        
        <!-- Game View Section (Initially Hidden) -->
        <div class="section hidden" id="gameSection">
            <h2>Spiel l√§uft</h2>
            
            <div class="role-display" id="playerRoleDisplay">
                <!-- Role will be displayed here -->
            </div>
            
            <h3>Spielerliste:</h3>
            <div class="player-list" id="gamePlayerList">
                <!-- Player list will be generated here -->
            </div>

            <div class="player-order-section">
                <h3>Spielerreihenfolge:</h3>
                <ol id="playerOrderList" class="player-order-list">
                    <!-- Spielerreihenfolge wird hier angezeigt -->
                </ol>
            </div>

            <div class="section" id="votingSection" style="display:none;">
                <h2>Abstimmungsphase</h2>
                
                <!-- F√ºr normale Spieler: Abstimmung -->
                <div id="normalPlayerVoting" style="display:none;">
                    <p>Wer ist deiner Meinung nach der Imposter?</p>
                    <div id="votingPlayerList" class="player-voting-list">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                    <p id="voteConfirmation" class="hidden" style="color: green; font-weight: bold;">Deine Stimme wurde gez√§hlt!</p>
                </div>
                
                <!-- F√ºr den Imposter: Wort erraten -->
                <div id="imposterGuessing" style="display:none;">
                    <p>Errate das geheime Wort:</p>
                    <input type="text" id="wordGuessInput" placeholder="Deine Vermutung...">
                    <button id="submitGuessBtn">Wort einreichen</button>
                    <p id="guessConfirmation" class="hidden" style="color: green; font-weight: bold;">Deine Vermutung wurde gesendet!</p>
                </div>
            </div>
            
            <div class="section" id="resultSection" style="display:none;">
                <h2>Spielergebnis</h2>
                <div id="resultContent">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
                <button id="startNewRoundBtn" class="hidden">Neue Runde starten</button>
            </div>
            
            <button id="endDiscussionBtn" style="display:none;">Diskussion beenden & Abstimmung starten</button>
            <button id="newGameBtn">Neues Spiel</button>
        </div>
    </div>

    <script>
        

    // Firebase-Konfiguration 
    const firebaseConfig = {
        apiKey: "AIzaSyCdEAZokf96Rmb4UfqR6MdCYDmlWlszxTA",
        authDomain: "imposter-wortspiel.firebaseapp.com",
        databaseURL: "https://imposter-wortspiel-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "imposter-wortspiel",
        storageBucket: "imposter-wortspiel.firebasestorage.app",
        messagingSenderId: "661252503301",
        appId: "1:661252503301:web:57766f2c4faa0b3f08296c"
    };
    
    // Firebase im Kompatibilit√§tsmodus initialisieren
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();



        
        // Word categories
        const wordCategories = {
            Tiere: [
                "Elefant", "Pinguin", "Giraffe", "L√∂we", "Tiger", "Zebra", "K√§nguru", "Nashorn", 
                "Koala", "Panda", "Delfin", "Wal", "Hai", "Frosch", "Schildkr√∂te", "Adler", 
                "Papagei", "Flamingo", "Krokodil", "Gorilla", "Eisb√§r", "Wolf", "Fuchs", 
                "Igel", "Eichh√∂rnchen", "Biber", "Otter", "Fledermaus"
            ],
            Berufe: [
                "Arzt", "Lehrer", "Koch", "Feuerwehrmann", "Polizist", "Pilot", "Architekt", 
                "Designer", "Programmierer", "Schauspieler", "Musiker", "K√ºnstler", "Anwalt", 
                "Richter", "Journalist", "Fotograf", "B√§cker", "G√§rtner", "Tischler", "Elektriker", 
                "Friseur", "Mechaniker", "Schneider", "Zahnarzt", "Tierarzt", "Krankenpfleger"
            ],
            Gegenstaende: [
                "Stuhl", "Tisch", "Lampe", "Uhr", "Buch", "Stift", "Handy", "Computer", "Fernseher", 
                "Kamera", "Brille", "Schl√ºssel", "Tasche", "Schirm", "Geldb√∂rse", "Schere", "Tasse", 
                "Flasche", "Messer", "Gabel", "L√∂ffel", "Teller", "Vase", "Kissen", "Decke", "Spiegel", 
                "Kerze", "Bild", "Ring", "Kette", "M√ºtze", "Schal"
            ],
            Orte: [
                "Strand", "Berg", "Wald", "W√ºste", "Insel", "Stadt", "Dorf", "Park", "Zoo", "Museum", 
                "Kino", "Theater", "Restaurant", "Caf√©", "Bahnhof", "Flughafen", "Hafen", "Schule", 
                "Universit√§t", "Krankenhaus", "Hotel", "Supermarkt", "Bibliothek", "Schwimmbad", 
                "Fitnessstudio", "B√ºro", "Fabrik", "Bauernhof", "Schloss", "Kirche"
            ],
            Essen: [
                "Pizza", "Burger", "Pasta", "Sushi", "Schokolade", "Eis", "Kuchen", "Brot", "K√§se", 
                "Suppe", "Salat", "Steak", "Fisch", "H√ºhnchen", "Reis", "Kartoffel", "Apfel", "Banane", 
                "Orange", "Erdbeere", "Tomate", "Gurke", "Karotte", "Kaffee", "Tee", "Saft", "Wasser", 
                "Bier", "Wein", "Milch"
            ]
        };
        
        // Spielzustand
        const gameState = {
            gameCode: '',
            word: '',
            category: '',
            players: [],
            imposterIndex: -1,
            started: false,
            currentPlayerName: '',
            votes: {},
            points: {}, 
            wordGuess: '',
            votingComplete: false,
            playersVoted: [],
            isHost: false
        };
        
        // DOM Elements
        const hostTab = document.getElementById('hostTab');
        const joinTab = document.getElementById('joinTab');
        const hostSection = document.getElementById('hostSection');
        const joinSection = document.getElementById('joinSection');
        const gameSection = document.getElementById('gameSection');
        
        const hostName = document.getElementById('hostName');
        const playerCount = document.getElementById('playerCount');
        const categorySelect = document.getElementById('categorySelect');
        const wordInput = document.getElementById('wordInput');
        const createGameBtn = document.getElementById('createGameBtn');
        
        const gameCodeSection = document.getElementById('gameCodeSection');
        const gameCodeDisplay = document.getElementById('gameCodeDisplay');
        const hostPlayerList = document.getElementById('hostPlayerList');
        const startGameBtn = document.getElementById('startGameBtn');
        
        const playerName = document.getElementById('playerName');
        const gameCodeInput = document.getElementById('gameCodeInput');
        const joinGameBtn = document.getElementById('joinGameBtn');
        
        const waitingRoomSection = document.getElementById('waitingRoomSection');
        const joinPlayerList = document.getElementById('joinPlayerList');
        
        const playerRoleDisplay = document.getElementById('playerRoleDisplay');
        const gamePlayerList = document.getElementById('gamePlayerList');
        const newGameBtn = document.getElementById('newGameBtn');
        
        // Tab navigation
        hostTab.addEventListener('click', () => {
            hostTab.classList.add('active');
            joinTab.classList.remove('active');
            hostSection.classList.remove('hidden');
            joinSection.classList.add('hidden');
        });
        
        joinTab.addEventListener('click', () => {
            joinTab.classList.add('active');
            hostTab.classList.remove('active');
            joinSection.classList.remove('hidden');
            hostSection.classList.add('hidden');
        });

        // Kategorie-Auswahl
        const categoryOptions = categorySelect.querySelectorAll('.category-option');
        categoryOptions.forEach(option => {
            option.addEventListener('click', () => {
                categoryOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                gameState.category = option.dataset.category;
            });
        });
        
        // Spielcode generieren
        function generateGameCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }


        
        
        // Spiel erstellen (Host) - Korrigierte Version
        createGameBtn.addEventListener('click', () => {
            const name = hostName.value.trim();
            const count = parseInt(playerCount.value);
            const customWord = wordInput.value.trim();
            
            if (name === '') {
                alert('Bitte gib deinen Namen ein.');
                return;
            }
            
            if (count < 3) {
                alert('Es m√ºssen mindestens 3 Spieler sein.');
                return;
            }
            
            if (!gameState.category && customWord === '') {
                alert('Bitte w√§hle eine Kategorie oder gib ein eigenes Wort ein.');
                return;
            }
            
            // Spielcode generieren
            const gameCode = generateGameCode();
            gameState.gameCode = gameCode;
            gameState.currentPlayerName = name;
            gameState.isHost = true;
            
            // Wort festlegen
            if (customWord !== '') {
                gameState.word = customWord;
                gameState.category = 'custom'; // Wichtig: Bei eigenem Wort Kategorie auf 'custom' setzen
            } else {
                const categoryWords = wordCategories[gameState.category];
                gameState.word = categoryWords[Math.floor(Math.random() * categoryWords.length)];
            }
            
            // Spieler hinzuf√ºgen
            gameState.players = [name];
            gameState.points = {};
            gameState.points[name] = 0;
            
            // Spiel in Firebase erstellen
            database.ref('games/' + gameCode).set({
                code: gameCode,
                word: gameState.word,
                category: gameState.category || 'custom',
                players: gameState.players,
                started: false,
                hostName: name,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                votes: {},           
                playersVoted: [],    
                votingPhase: false,
                points: gameState.points  // NEU: Punktestand der Spieler
            });
            
            // Host dieser Spielsitzung zuordnen
            database.ref('games/' + gameCode + '/players').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.players = snapshot.val();
                    updateHostPlayerList();
                    
                    if (gameState.players.length >= 3) {
                        startGameBtn.classList.remove('hidden');
                    }
                }
            });
        
            database.ref('games/' + gameCode + '/playerOrder').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.playerOrder = snapshot.val();
                    if (gameState.started) {
                        updatePlayerOrderList();
                    }
                }
            });
            
            // Spielstatus √ºberwachen
            database.ref('games/' + gameCode + '/started').on('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    gameState.started = true;
                    
                    // Imposter-Index abrufen
                    database.ref('games/' + gameCode + '/imposterIndex').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            gameState.imposterIndex = snapshot.val();
                            showGameView();
                        }
                    });
                }
            });

            database.ref('games/' + gameCode + '/points').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.points = snapshot.val();
                }
            });
            
            // Spielcode anzeigen
            gameCodeDisplay.textContent = gameCode;
            gameCodeSection.classList.remove('hidden');
        });
        





        
        // Spiel beitreten (Spieler) - Fehlerbehebung
        joinGameBtn.addEventListener('click', () => {
            const name = playerName.value.trim();
            const code = gameCodeInput.value.trim().toUpperCase();
            
            if (name === '') {
                alert('Bitte gib deinen Namen ein.');
                return;
            }
            
            if (code === '') {
                alert('Bitte gib den Spiel-Code ein.');
                return;
            }
        
            database.ref('games/' + code + '/playerOrder').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.playerOrder = snapshot.val();
                    if (gameState.started) {
                        updatePlayerOrderList();
                    }
                }
            });
            
            // Pr√ºfen, ob Spiel existiert
            database.ref('games/' + code).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const game = snapshot.val();
                    
                    // Pr√ºfen, ob Name bereits verwendet wird
                    if (game.players && game.players.includes(name)) {
                        alert('Dieser Name wird bereits verwendet. Bitte w√§hle einen anderen Namen.');
                        return;
                    }
                    
                    // Pr√ºfen, ob Spiel bereits gestartet ist
                    if (game.started) {
                        alert('Das Spiel hat bereits begonnen. Bitte trete einem anderen Spiel bei.');
                        return;
                    }
                    
                    // Spieler zum Spiel hinzuf√ºgen
                    gameState.gameCode = code;
                    gameState.currentPlayerName = name;
                    
                    // WICHTIG: Kategorie vom Spiel abrufen und lokal speichern
                    gameState.category = game.category;
                    
                    // Spielerliste f√ºr Spieler initialisieren
                    gameState.players = game.players || [];
                    if (!gameState.players.includes(name)) {
                        gameState.players.push(name);
                    }

                    // Punkte des Spielers initialisieren
                    database.ref('games/' + code + '/points/' + name).once('value', (snapshot) => {
                        if (!snapshot.exists()) {
                            // Wenn der Spieler neu ist, setze seine Punkte auf 0
                            database.ref('games/' + code + '/points/' + name).set(0);
                        }
                    });
                    
                    // Spieler zur Spielerliste in Firebase hinzuf√ºgen
                    database.ref('games/' + code + '/players').set(gameState.players);
                    
                    // Spielzustand √ºberwachen
                    database.ref('games/' + code + '/players').on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            gameState.players = snapshot.val();
                            gameState.playerOrder = [];
                            updateJoinPlayerList();
                        }
                    });
                    
                    // Spielstatus √ºberwachen
                    database.ref('games/' + code + '/started').on('value', (snapshot) => {
                        if (snapshot.exists() && snapshot.val() === true) {
                            gameState.started = true;
                            
                            // Spielwort, Kategorie und Imposter-Index abrufen
                            database.ref('games/' + code).once('value', (snapshot) => {
                                if (snapshot.exists()) {
                                    const gameData = snapshot.val();
                                    gameState.word = gameData.word;
                                    gameState.category = gameData.category; // Kategorie aktualisieren
                                    gameState.imposterIndex = gameData.imposterIndex;
                                    showGameView();
                                }
                            });
                        }
                    });
                    
                    // Warteraum anzeigen
                    waitingRoomSection.classList.remove('hidden');
                } else {
                    alert('Ung√ºltiger Spiel-Code. Bitte √ºberpr√ºfe den Code und versuche es erneut.');
                }
            });

            database.ref('games/' + code + '/points').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState.points = snapshot.val();
                }
            });
        });






        // Verbesserte Version des startGameBtn Event-Listeners
        startGameBtn.addEventListener('click', () => {
            console.log("Spiel starten Button wurde geklickt"); // Debug-Ausgabe
            
            if (!gameState.isHost) {
                console.log("Nicht der Host, Aktion ignoriert");
                return;
            }
            
            if (gameState.players.length < 3) {
                alert('Es m√ºssen mindestens 3 Spieler sein, um das Spiel zu starten.');
                return;
            }
            
            // √úberpr√ºfe ob Wort und Kategorie vorhanden sind
            if (!gameState.category || gameState.category === '') {
                alert('Bitte w√§hle eine Kategorie oder gib ein eigenes Wort ein.');
                return;
            }
            
            if (!gameState.word || gameState.word === '') {
                // Neu-Generierung des Wortes falls nicht vorhanden
                if (gameState.category !== 'custom') {
                    const categoryWords = wordCategories[gameState.category];
                    gameState.word = categoryWords[Math.floor(Math.random() * categoryWords.length)];
                } else {
                    alert('Bitte gib ein eigenes Wort ein.');
                    return;
                }
            }
            
            // Imposter zuf√§llig ausw√§hlen
            const imposterIndex = Math.floor(Math.random() * gameState.players.length);
            
            // Zuf√§llige Spielerreihenfolge erstellen
            const playerOrder = createRandomPlayerOrder(gameState.players);
            
            console.log("Starte Spiel mit:", {
                imposterIndex,
                playerCount: gameState.players.length,
                category: gameState.category,
                word: gameState.word
            });
            
            // Spiel starten und Imposter sowie Spielerreihenfolge setzen
            database.ref('games/' + gameState.gameCode).update({
                started: true,
                imposterIndex: imposterIndex,
                playerOrder: playerOrder,
                category: gameState.category,
                word: gameState.word,
                votingPhase: false,  // Wichtig: Stellen Sie sicher, dass die Abstimmungsphase zu Beginn falsch ist
                votes: null,         // Alte Stimmen zur√ºcksetzen
                playersVoted: [],    // Liste der abgestimmten Spieler zur√ºcksetzen
                wordGuess: null      // Wortsch√§tzung zur√ºcksetzen
            });
            
            gameState.imposterIndex = imposterIndex;
            gameState.playerOrder = playerOrder;
            gameState.started = true; 
            gameState.wordGuess = ""; 
            gameState.votingPhase = false;
            gameState.votes = {};
            gameState.playersVoted = [];
            
            // Gameview direkt anzeigen
            showGameView();
        });
        
        
        // Neues Spiel starten
        newGameBtn.addEventListener('click', () => {
            // Spiel verlassen und zur√ºcksetzen
            if (gameState.gameCode) {
                // Vom Firebase-Listener abmelden
                database.ref('games/' + gameState.gameCode).off();
                
                // Wenn Host und keine Spieler mehr da sind, Spiel l√∂schen
                if (gameState.isHost) {
                    database.ref('games/' + gameState.gameCode).remove();
                } else {
                    // Spieler aus Liste entfernen
                    database.ref('games/' + gameState.gameCode + '/players').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const players = snapshot.val();
                            const index = players.indexOf(gameState.currentPlayerName);
                            if (index !== -1) {
                                players.splice(index, 1);
                                database.ref('games/' + gameState.gameCode + '/players').set(players);
                            }
                        }
                    });
                    
                    if (!gameState.isHost) {
                        database.ref('games/' + gameState.gameCode + '/points/' + gameState.currentPlayerName).remove();
                    }
                }
            }
            
            // Gamestate zur√ºcksetzen
            gameState.gameCode = '';
            gameState.word = '';
            gameState.category = '';
            gameState.players = [];
            gameState.imposterIndex = -1;
            gameState.started = false;
            gameState.isHost = false;
            gameState.votes = {};
            gameState.points = {}; 
            gameState.wordGuess = '';
            gameState.votingComplete = false;
            gameState.playersVoted = [];
            gameState.votingPhase = false;
            
            // UI zur√ºcksetzen
            hostSection.classList.remove('hidden');
            joinSection.classList.add('hidden');
            gameSection.classList.add('hidden');
            gameCodeSection.classList.add('hidden');
            waitingRoomSection.classList.add('hidden');
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('endDiscussionBtn').style.display = 'none';
            document.getElementById('normalPlayerVoting').style.display = 'none';
            document.getElementById('imposterGuessing').style.display = 'none';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            
            // WICHTIG: Formular-Elemente explizit zur√ºcksetzen
            document.getElementById('submitGuessBtn').disabled = false; 
            document.getElementById('wordGuessInput').value = '';
            
            // Eingaben und Auswahlen zur√ºcksetzen
            wordInput.value = '';
            gameCodeInput.value = '';
            categoryOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Tabs zur√ºcksetzen
            hostTab.classList.add('active');
            joinTab.classList.remove('active');
        });



        // Neue Runde starten EventListener - korrigierte Version
        document.getElementById('startNewRoundBtn').addEventListener('click', () => {
            if (!gameState.isHost) return;
            
            // Lokalen Spielzustand vollst√§ndig zur√ºcksetzen
            gameState.started = false;
            gameState.votes = {};
            gameState.wordGuess = '';
            gameState.votingComplete = false;
            gameState.playersVoted = [];
            gameState.imposterIndex = -1;
            gameState.playerOrder = [];
            gameState.votingPhase = false;
            
            // UI-Elemente vollst√§ndig zur√ºcksetzen
            gameSection.classList.add('hidden');
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('normalPlayerVoting').style.display = 'none';
            document.getElementById('imposterGuessing').style.display = 'none';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            document.getElementById('endDiscussionBtn').style.display = 'none'; 
            document.getElementById('startNewRoundBtn').classList.add('hidden');
            
            // WICHTIG: Formular-Elemente explizit zur√ºcksetzen
            document.getElementById('submitGuessBtn').disabled = false; 
            document.getElementById('wordGuessInput').value = '';
            
            // Host-Interface mit Spielern anzeigen
            hostSection.classList.remove('hidden');
            gameCodeSection.classList.remove('hidden');
            startGameBtn.classList.remove('hidden');
            
            // Alle Kategorie-Optionen zur√ºcksetzen
            categoryOptions.forEach(opt => opt.classList.remove('selected'));
            wordInput.value = '';
            
            // Kategorie und Wort lokal zur√ºcksetzen
            gameState.category = ''; 
            gameState.word = '';
            
            // Firebase vollst√§ndig zur√ºcksetzen
            database.ref('games/' + gameState.gameCode).update({
                started: false,
                votes: null,
                playersVoted: [],
                votingPhase: false,
                wordGuess: null,
                imposterIndex: null,
                playerOrder: null,
                category: null,
                word: null
            });
            
            // Spielerliste f√ºr Host aktualisieren
            updateHostPlayerList();
        });


        
        
        // Au√üerdem m√ºssen wir die showGameView-Funktion modifizieren, damit sie die Formular-Elemente korrekt zur√ºcksetzt:
        function showGameView() {
            hostSection.classList.add('hidden');
            joinSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
            
            // Formular-Elemente zur√ºcksetzen
            document.getElementById('submitGuessBtn').disabled = false;
            document.getElementById('wordGuessInput').value = '';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            
            // Aktuelle Spielinformationen aus Firebase laden
            database.ref('games/' + gameState.gameCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    
                    // Aktualisiere den lokalen Spielzustand mit den Daten aus Firebase
                    gameState.word = gameData.word;
                    gameState.category = gameData.category;
                    gameState.imposterIndex = gameData.imposterIndex;
                    
                    // Spielerrolle anzeigen
                    const playerIndex = gameState.players.indexOf(gameState.currentPlayerName);
                    
                    playerRoleDisplay.classList.remove('normal-player', 'imposter');
                    
                    if (playerIndex === gameState.imposterIndex) {
                        playerRoleDisplay.classList.add('imposter');
                        playerRoleDisplay.innerHTML = `
                            <p>Du bist der <strong>IMPOSTER</strong>!</p>
                            <p>Die Kategorie ist: <span class="word-display">${gameState.category}</span></p>
                            <p>Alle anderen Spieler kennen ein geheimes Wort, das du erraten musst.</p>
                            <p>H√∂re gut zu und versuche nicht aufzufallen!</p>
                        `;
                    } else {
                        playerRoleDisplay.classList.add('normal-player');
                        playerRoleDisplay.innerHTML = `
                            <p>Du bist ein <strong>normaler Spieler</strong>!</p>
                            <p>Die Kategorie ist: <span class="word-display">${gameState.category}</span></p>
                            <p>Das geheime Wort ist: <span class="word-display">${gameState.word}</span></p>
                            <p>Beschreibe das Wort, ohne es direkt zu nennen. Versuche den Imposter zu erkennen!</p>
                        `;
                    }
                
                    updateGamePlayerList();
                    
                    // Spielerreihenfolge anzeigen, wenn vorhanden
                    if (gameState.playerOrder && gameState.playerOrder.length > 0) {
                        updatePlayerOrderList();
                    }
                    
                    // "Diskussion beenden"-Button nur f√ºr Host anzeigen
                    if (gameState.isHost) {
                        document.getElementById('endDiscussionBtn').style.display = 'block';
                    }
                    
                    // Abstimmungs- und Ergebnislistener einrichten
                    setupVotingPhaseListener();
                    setupVotingResultsListener();
                }
            });
        }
        
        // Zus√§tzlich m√ºssen wir die setupVotingResultsListener-Funktion anpassen:
        function setupVotingResultsListener() {
            // Abstimmungsergebnisse √ºberwachen
            database.ref('games/' + gameState.gameCode + '/playersVoted').on('value', (snapshot) => {
                if (snapshot.exists() && gameState.started) {
                    const playersVoted = snapshot.val();
                    
                    // Wenn alle Spieler abgestimmt haben
                    if (playersVoted.length === gameState.players.length) {
                        showResults();
                    }
                }
            });
        
            // Spielneustart √ºberwachen
            database.ref('games/' + gameState.gameCode + '/started').on('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() === false && gameState.started === true) {
                    // Spielzustand zur√ºcksetzen
                    gameState.started = false;
                    gameState.votes = {};
                    gameState.wordGuess = '';
                    gameState.votingComplete = false;
                    gameState.playersVoted = [];
                    gameState.imposterIndex = -1;
                    gameState.playerOrder = [];
                    gameState.votingPhase = false;
                    
                    // UI f√ºr alle Spieler zur√ºcksetzen
                    document.getElementById('votingSection').style.display = 'none';
                    document.getElementById('resultSection').style.display = 'none';
                    document.getElementById('normalPlayerVoting').style.display = 'none';
                    document.getElementById('imposterGuessing').style.display = 'none';
                    document.getElementById('voteConfirmation').classList.add('hidden');
                    document.getElementById('guessConfirmation').classList.add('hidden');
                    document.getElementById('endDiscussionBtn').style.display = 'none';
                    gameSection.classList.add('hidden');
                    
                    // WICHTIG: Formular-Elemente explizit zur√ºcksetzen
                    document.getElementById('submitGuessBtn').disabled = false;
                    document.getElementById('wordGuessInput').value = '';
                    
                    if (!gameState.isHost) {
                        // Nicht-Host-Spieler in den Warteraum zur√ºcksetzen
                        joinSection.classList.remove('hidden');
                        waitingRoomSection.classList.remove('hidden');
                        updateJoinPlayerList(); // Spielerliste im Warteraum aktualisieren
                    }
                }
            });
        }




        
        
        // Spielerlisten aktualisieren (wie in deinem Original-Code)
        function updateHostPlayerList() {
            hostPlayerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.textContent = player;
                hostPlayerList.appendChild(playerCard);
            });
        }
        
        function updateJoinPlayerList() {
            joinPlayerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.textContent = player;
                joinPlayerList.appendChild(playerCard);
            });
        }
        
        function updateGamePlayerList() {
            gamePlayerList.innerHTML = '';
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.classList.add('player-card');
                playerCard.textContent = player;
                gamePlayerList.appendChild(playerCard);
            });
        }

        function updatePlayerOrderList() {
            const playerOrderList = document.getElementById('playerOrderList');
            playerOrderList.innerHTML = '';
            
            gameState.playerOrder.forEach(player => {
                const li = document.createElement('li');
                li.textContent = player; // Nur den Spielernamen ohne Nummerierung
                playerOrderList.appendChild(li);
            });
        }

        function createRandomPlayerOrder(players) {
            // Kopie der Spielerliste erstellen
            const shuffledPlayers = [...players];
            
            // Fisher-Yates Shuffle Algorithmus
            for (let i = shuffledPlayers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledPlayers[i], shuffledPlayers[j]] = [shuffledPlayers[j], shuffledPlayers[i]];
            }
            
            return shuffledPlayers;
        }




        
        // Spielansicht anzeigen - Korrigierte Version
        function showGameView() {
            hostSection.classList.add('hidden');
            joinSection.classList.add('hidden');
            gameSection.classList.remove('hidden');
            
            // Zun√§chst aktuelle Spielinformationen aus Firebase laden, um sicherzustellen,
            // dass wir die neuesten Kategorie- und Wortinformationen haben
            database.ref('games/' + gameState.gameCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    
                    // Aktualisiere den lokalen Spielzustand mit den Daten aus Firebase
                    gameState.word = gameData.word;
                    gameState.category = gameData.category;
                    gameState.imposterIndex = gameData.imposterIndex;
                    
                    // Spielerrolle anzeigen
                    const playerIndex = gameState.players.indexOf(gameState.currentPlayerName);
                    
                    playerRoleDisplay.classList.remove('normal-player', 'imposter');
                    
                    if (playerIndex === gameState.imposterIndex) {
                        playerRoleDisplay.classList.add('imposter');
                        playerRoleDisplay.innerHTML = `
                            <p>Du bist der <strong>IMPOSTER</strong>!</p>
                            <p>Die Kategorie ist: <span class="word-display">${gameState.category}</span></p>
                            <p>Alle anderen Spieler kennen ein geheimes Wort, das du erraten musst.</p>
                            <p>H√∂re gut zu und versuche nicht aufzufallen!</p>
                        `;
                    } else {
                        playerRoleDisplay.classList.add('normal-player');
                        playerRoleDisplay.innerHTML = `
                            <p>Du bist ein <strong>normaler Spieler</strong>!</p>
                            <p>Die Kategorie ist: <span class="word-display">${gameState.category}</span></p>
                            <p>Das geheime Wort ist: <span class="word-display">${gameState.word}</span></p>
                            <p>Beschreibe das Wort, ohne es direkt zu nennen. Versuche den Imposter zu erkennen!</p>
                        `;
                    }
                
                    updateGamePlayerList();
                    
                    // Spielerreihenfolge anzeigen, wenn vorhanden
                    if (gameState.playerOrder && gameState.playerOrder.length > 0) {
                        updatePlayerOrderList();
                    }
                    
                    // "Diskussion beenden"-Button nur f√ºr Host anzeigen
                    if (gameState.isHost) {
                        document.getElementById('endDiscussionBtn').style.display = 'block';
                    }
                    
                    // Abstimmungs- und Ergebnislistener einrichten
                    setupVotingPhaseListener();
                    setupVotingResultsListener();
                }
            });
        }







        
        
        // Auto-Cleanup f√ºr inaktive Spiele (optional)
        window.addEventListener('beforeunload', () => {
            if (gameState.gameCode) {
                // Vom Firebase-Listener abmelden
                database.ref('games/' + gameState.gameCode).off();
                
                if (gameState.isHost) {
                    // Als Host: Spiel l√∂schen
                    database.ref('games/' + gameState.gameCode).remove();
                } else {
                    // Als Spieler: Aus Spielerliste entfernen UND Punkte zur√ºcksetzen
                    database.ref('games/' + gameState.gameCode + '/players').once('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const players = snapshot.val();
                            const index = players.indexOf(gameState.currentPlayerName);
                            if (index !== -1) {
                                players.splice(index, 1);
                                database.ref('games/' + gameState.gameCode + '/players').set(players);
                                // Punkte des Spielers l√∂schen
                                database.ref('games/' + gameState.gameCode + '/points/' + gameState.currentPlayerName).remove();
                            }
                        }
                    });
                }
            }
        });








        // Diskussion beenden und Abstimmung starten
        document.getElementById('endDiscussionBtn').addEventListener('click', () => {
            if (!gameState.isHost) return;
            
            database.ref('games/' + gameState.gameCode).update({
                votingPhase: true
            });
        });
        
        // √úberwachung der Abstimmungsphase
        function setupVotingPhaseListener() {
            database.ref('games/' + gameState.gameCode + '/votingPhase').on('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() === true) {
                    showVotingSection();
                }
            });
        }
        
        // Zeige Abstimmungssektion
        function showVotingSection() {
            document.getElementById('endDiscussionBtn').style.display = 'none';
            document.getElementById('votingSection').style.display = 'block';
            
            // Zur√ºcksetzen der Formularelemente
            document.getElementById('submitGuessBtn').disabled = false;
            document.getElementById('wordGuessInput').value = '';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            
            const playerIndex = gameState.players.indexOf(gameState.currentPlayerName);
            
            if (playerIndex === gameState.imposterIndex) {
                // Imposter sieht Ratefeld
                document.getElementById('imposterGuessing').style.display = 'block';
                document.getElementById('normalPlayerVoting').style.display = 'none';
            } else {
                // Normale Spieler sehen Abstimmungsoptionen
                document.getElementById('normalPlayerVoting').style.display = 'block';
                document.getElementById('imposterGuessing').style.display = 'none';
                populateVotingOptions();
            }
        }

// Abstimmungsoptionen anzeigen
function populateVotingOptions() {
    const votingList = document.getElementById('votingPlayerList');
    votingList.innerHTML = '';
    
    gameState.players.forEach(player => {
        if (player !== gameState.currentPlayerName) { // Nicht f√ºr sich selbst stimmen
            const option = document.createElement('div');
            option.classList.add('player-voting-option');
            option.textContent = player;
            option.dataset.player = player;
            
            option.addEventListener('click', () => {
                // Vorherige Auswahl entfernen
                document.querySelectorAll('.player-voting-option.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                
                // Neue Auswahl markieren
                option.classList.add('selected');
                
                // Stimme in Firebase speichern
                const voteRef = database.ref('games/' + gameState.gameCode + '/votes/' + gameState.currentPlayerName);
                voteRef.set(player);
                
                // Abstimmungsbest√§tigung anzeigen
                document.getElementById('voteConfirmation').classList.remove('hidden');
                
                // Spieler zur Liste der abgestimmten Spieler hinzuf√ºgen
                database.ref('games/' + gameState.gameCode + '/playersVoted').once('value', (snapshot) => {
                    let playersVoted = [];
                    if (snapshot.exists()) {
                        playersVoted = snapshot.val();
                    }
                    
                    if (!playersVoted.includes(gameState.currentPlayerName)) {
                        playersVoted.push(gameState.currentPlayerName);
                        database.ref('games/' + gameState.gameCode + '/playersVoted').set(playersVoted);
                    }
                });
            });
            
            votingList.appendChild(option);
        }
    });
}

// Imposter-Rateversuch
document.getElementById('submitGuessBtn').addEventListener('click', () => {
    const wordGuess = document.getElementById('wordGuessInput').value.trim();
    
    if (wordGuess === '') {
        alert('Bitte gib eine Vermutung ein!');
        return;
    }
    
    // Button deaktivieren um Mehrfach-Klicks zu verhindern
    document.getElementById('submitGuessBtn').disabled = true;
    
    // Vermutung in Firebase speichern
    database.ref('games/' + gameState.gameCode + '/wordGuess').set(wordGuess)
        .then(() => {
            // Best√§tigung anzeigen
            document.getElementById('guessConfirmation').classList.remove('hidden');
            
            // Imposter zur Liste der abgestimmten Spieler hinzuf√ºgen
            return database.ref('games/' + gameState.gameCode + '/playersVoted').once('value');
        })
        .then((snapshot) => {
            let playersVoted = [];
            if (snapshot.exists()) {
                playersVoted = snapshot.val();
            }
            
            if (!playersVoted.includes(gameState.currentPlayerName)) {
                playersVoted.push(gameState.currentPlayerName);
                return database.ref('games/' + gameState.gameCode + '/playersVoted').set(playersVoted);
            }
        })
        .catch((error) => {
            console.error("Fehler beim Speichern der Vermutung:", error);
            // Bei Fehler den Button wieder aktivieren
            document.getElementById('submitGuessBtn').disabled = false;
            alert("Es gab ein Problem beim Speichern deiner Vermutung. Bitte versuche es erneut.");
        });
});

// Verbesserte √úberwachung der Abstimmungsergebnisse
function setupVotingResultsListener() {
    // Abstimmungsergebnisse √ºberwachen
    database.ref('games/' + gameState.gameCode + '/playersVoted').on('value', (snapshot) => {
        if (snapshot.exists() && gameState.started) {
            const playersVoted = snapshot.val();
            
            // Wenn alle Spieler abgestimmt haben
            if (playersVoted.length === gameState.players.length) {
                showResults();
            }
        }
    });

    // Spielneustart √ºberwachen
    database.ref('games/' + gameState.gameCode + '/started').on('value', (snapshot) => {
        if (snapshot.exists() && snapshot.val() === false && gameState.started === true) {
            // Spielzustand zur√ºcksetzen
            gameState.started = false;
            gameState.votes = {};
            gameState.wordGuess = '';
            gameState.votingComplete = false;
            gameState.playersVoted = [];
            gameState.imposterIndex = -1;
            gameState.playerOrder = [];
            
            // UI f√ºr alle Spieler zur√ºcksetzen
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('normalPlayerVoting').style.display = 'none';
            document.getElementById('imposterGuessing').style.display = 'none';
            document.getElementById('voteConfirmation').classList.add('hidden');
            document.getElementById('guessConfirmation').classList.add('hidden');
            document.getElementById('endDiscussionBtn').style.display = 'none';
            gameSection.classList.add('hidden');
            
            if (!gameState.isHost) {
                // Nicht-Host-Spieler in den Warteraum zur√ºcksetzen
                joinSection.classList.remove('hidden');
                waitingRoomSection.classList.remove('hidden');
                updateJoinPlayerList(); // Spielerliste im Warteraum aktualisieren
            }
        }
    });
}

        // Verbesserte Funktion zum Anzeigen der Ergebnisse
        function showResults() {
            document.getElementById('votingSection').style.display = 'none';
            document.getElementById('resultSection').style.display = 'block';
            
            // Abstimmungsergebnisse und Imposter-Vermutung abrufen
            database.ref('games/' + gameState.gameCode).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const gameData = snapshot.val();
                    const votes = gameData.votes || {};
                    const wordGuess = gameData.wordGuess || "nichts geraten";
                    const imposter = gameState.players[gameState.imposterIndex];
                    const previousPoints = gameData.points || {};
                    
                    // Neue Punkte f√ºr diese Runde berechnen
                    let newPoints = {...previousPoints};
                    
                    // Stimmen z√§hlen
                    const voteCounts = {};
                    Object.entries(votes).forEach(([voter, votedFor]) => {
                        voteCounts[votedFor] = (voteCounts[votedFor] || 0) + 1;
                        
                        // Pr√ºfen, ob ein normaler Spieler den Imposter richtig erraten hat
                        if (votedFor === imposter && voter !== imposter) {
                            // Normaler Spieler hat den Imposter erraten: +1 Punkt
                            newPoints[voter] = (newPoints[voter] || 0) + 1;
                        }
                    });
                    
                    // Punkte f√ºr den Imposter berechnen
                    // 1. F√ºr jede falsche Anschuldigung (jeder der NICHT f√ºr den Imposter gestimmt hat)
                    gameState.players.forEach(player => {
                        if (player !== imposter && votes[player] !== imposter) {
                            // Imposter hat einen Spieler get√§uscht: +1 Punkt
                            newPoints[imposter] = (newPoints[imposter] || 0) + 1;
                        }
                    });
                    
                    // 2. Hat der Imposter das Wort erraten?
                    const wordGuessCorrect = wordGuess.toLowerCase() === gameState.word.toLowerCase();
                    if (wordGuessCorrect) {
                        // Imposter hat das Wort erraten: +1 Punkt
                        newPoints[imposter] = (newPoints[imposter] || 0) + 1;
                    }
                    
                    // Meistgew√§hlten Spieler ermitteln
                    let maxVotes = 0;
                    let mostVotedPlayer = "";
                    for (const player in voteCounts) {
                        if (voteCounts[player] > maxVotes) {
                            maxVotes = voteCounts[player];
                            mostVotedPlayer = player;
                        }
                    }
                    
                    // Punkte in Firebase aktualisieren
                    database.ref('games/' + gameState.gameCode + '/points').set(newPoints);
                    gameState.points = newPoints;
                    
                    // Ergebnisse anzeigen
                    const resultContent = document.getElementById('resultContent');
                    
                    let resultHTML = `
                        <p>Der <span class="imposter-reveal">Imposter</span> war: <strong>${imposter}</strong></p>
                        <p>Das geheime Wort war: <span class="word-reveal">${gameState.word}</span></p>
                        <p>Der Imposter hat geraten: <strong>${wordGuess}</strong> ${wordGuessCorrect ? '‚úì' : '‚úó'}</p>
                        <p>Die meisten Stimmen erhielt: <strong>${mostVotedPlayer}</strong> (${maxVotes} Stimmen)</p>
                        
                        <h3>Punkte√ºbersicht:</h3>
                        <div class="points-list">
                    `;
                    
                    // Spieler nach Punkten sortieren (absteigend)
                    const sortedPlayers = [...gameState.players].sort((a, b) => 
                        (newPoints[b] || 0) - (newPoints[a] || 0)
                    );
                    
                    sortedPlayers.forEach(player => {
                        const isImposter = player === imposter ? ' (Imposter)' : '';
                        resultHTML += `<div class="points-item">
                            <span class="player-name">${player}${isImposter}</span>
                            <span class="points-count">${newPoints[player] || 0} Punkte</span>
                        </div>`;
                    });
                    
                    resultHTML += `</div>`;
                    
                    // Spielergebnis anzeigen
                    let gameOutcome = '';                  
                    resultHTML += gameOutcome;
                    resultContent.innerHTML = resultHTML;
                }
            });
            
            // "Neue Runde starten"-Button nur f√ºr Host anzeigen
            if (gameState.isHost) {
                document.getElementById('startNewRoundBtn').classList.remove('hidden');
            }
        }


        


        // Dark Mode Funktionalit√§t
        const themeToggle = document.getElementById('themeToggle');
        let darkMode = localStorage.getItem('darkMode') === 'true';
        
        // Beim Laden der Seite pr√ºfen, ob Dark Mode aktiviert sein sollte
        if (darkMode) {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = '‚òÄÔ∏è';
        }
        
        // Toggle Dark Mode Funktion
        themeToggle.addEventListener('click', () => {
            darkMode = !darkMode;
            localStorage.setItem('darkMode', darkMode);
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåô';
            }
        });

        
    </script>
</body>
</html>
